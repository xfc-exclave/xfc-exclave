<!DOCTYPE html><html lang="ja"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="チンモクのブログ" href="https://www.chinmoku.cc/rss.xml"><link rel="alternate" type="application/atom+xml" title="チンモクのブログ" href="https://www.chinmoku.cc/atom.xml"><link rel="alternate" type="application/json" title="チンモクのブログ" href="https://www.chinmoku.cc/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="java,Spring Cloud Alibaba"><link rel="canonical" href="https://www.chinmoku.cc/computer-science/java-learning-path/3-advanced/redis-tutorial/"><title>Redis 如何保证高性能 - 进阶篇 - JAVA 学习路线 - 计算机科学 | Chinmoku = チンモクのブログ = 露の世は　露の世ながら　さりながら</title><meta name="generator" content="Hexo 5.4.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">Redis 如何保证高性能</h1><div class="meta"><span class="item" title="作成日：2022-02-14 12:08:17"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">投稿日</span> <time itemprop="dateCreated datePublished" datetime="2022-02-14T12:08:17+08:00">2022-02-14</time> </span><span class="item" title="単語数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">単語数</span> <span>22k</span> <span class="text">単語</span> </span><span class="item" title="読書の時間"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">読書の時間</span> <span>20 分</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="ナビゲーションバーの切り替え"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Chinmoku</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://reference-1301046789.cos.ap-nanjing.myqcloud.com/blog-img/4ae1442a0f73424c8987519b5681a4bd.jpg"></li><li class="item" data-background-image="https://reference-1301046789.cos.ap-nanjing.myqcloud.com/blog-img/4decaf34f91f4614832d697333b4ed9d.jpg"></li><li class="item" data-background-image="https://reference-1301046789.cos.ap-nanjing.myqcloud.com/blog-img/1bcdc38e208c49ec82ab8d479c377176.jpg"></li><li class="item" data-background-image="https://reference-1301046789.cos.ap-nanjing.myqcloud.com/blog-img/8ed354f4fff64091b043dcecfd6769a4.jpg"></li><li class="item" data-background-image="https://reference-1301046789.cos.ap-nanjing.myqcloud.com/blog-img/55c2ff13880611ebb6edd017c2d2eca2.png"></li><li class="item" data-background-image="https://reference-1301046789.cos.ap-nanjing.myqcloud.com/blog-img/07b503e152ef46a986cc0e6652bc0307.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">ホーム</a></span><i class="ic i-angle-right"></i> <span itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/computer-science/" itemprop="item" rel="index" title="カテゴリ 计算机科学"><span itemprop="name">计算机科学</span></a><meta itemprop="position" content="1"></span><i class="ic i-angle-right"></i> <span itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/computer-science/java-learning-path/" itemprop="item" rel="index" title="カテゴリ JAVA 学习路线"><span itemprop="name">JAVA 学习路线</span></a><meta itemprop="position" content="2"></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/computer-science/java-learning-path/%E8%BF%9B%E9%98%B6%E7%AF%87/" itemprop="item" rel="index" title="カテゴリ 进阶篇"><span itemprop="name">进阶篇</span></a><meta itemprop="position" content="3"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="ja"><link itemprop="mainEntityOfPage" href="https://www.chinmoku.cc/computer-science/java-learning-path/3-advanced/redis-tutorial/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="チンモク"><meta itemprop="description" content="露の世は　露の世ながら　さりながら, 本站主要以 Java 开发总结文章为主，也会向技术周边进行适当的扩展。此外，偶尔会更新部分其他学习或感兴趣的内容，如语言学习、文本翻译、文艺创作等。"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="チンモクのブログ"></span><div class="body md" itemprop="articleBody"><div class="note info no-icon"><p>最近是真的是太懒了😥，都快忘记要写博客这一回事了。之前还可以借口说工作太忙，现在就只能坦率地承认了。意识到这点，赶紧狠狠地呼了自己一耳光，继续学习，😡Fighting！！！。</p></div><h3 id="redis-简介"><a class="anchor" href="#redis-简介">#</a> Redis 简介</h3><blockquote><p>关于 NoSQL 的优缺点，及其与关系型数据库的对比，此前已在 <a href="/computer-science/java-learning-path/3-advanced/mongodb-tutorial/">MongoDB 基础教程</a>一文中已有描述，可自行前往查看。</p></blockquote><p>Redis 诞生于 2009 年，其全称是 Remote Dictionary Server，远程词典服务器，是一个基于内存的键值型 NoSQL 数据库。</p><p>Redis 特征：</p><ul><li>键值型，value 支持多种不同数据结构，功能丰富。</li><li>单线程，每个命令具备原子性。</li><li>低延迟，速度快（基于内存，IO 多路复用，良好的编码）。</li><li>支持数据持久化。</li><li>支持主从集群、分片集群。</li><li>支持多语言客户端。</li></ul><h3 id="卸载安装"><a class="anchor" href="#卸载安装">#</a> 卸载安装</h3><h4 id="redis-卸载"><a class="anchor" href="#redis-卸载">#</a> Redis 卸载</h4><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">ps</span> aux <span class="token operator">|</span> <span class="token function">grep</span> redis <span class="token comment"># 查看是否启动 redis，如已启动则停止</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">whereis</span> redis <span class="token comment"># 搜索 redis，核对并删除对应文件及目录</span></pre></td></tr></table></figure><h4 id="redis-安装"><a class="anchor" href="#redis-安装">#</a> Redis 安装</h4><ol><li><p>Redis 安装启动</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token builtin class-name">cd</span> /usr/local</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">mkdir</span> redis</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token builtin class-name">cd</span> redis/</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token function">wget</span> https://download.redis.io/releases/redis-6.2.6.tar.gz</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token function">tar</span> xzf redis-6.2.6.tar.gz</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token builtin class-name">cd</span> redis-6.2.6</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token function">make</span> <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token function">install</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment"># 检查安装</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token builtin class-name">cd</span> /usr/local/bin</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># 任意位置运行 redis</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token builtin class-name">cd</span> ~</pre></td></tr><tr><td data-num="12"></td><td><pre>redis-server <span class="token comment"># 前台启动</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment"># 后台启动</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token builtin class-name">cd</span> /usr/local/redis/redis-6.2.6</pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token function">cp</span> redis.conf redis.conf.backup <span class="token comment"># backup</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token function">vi</span> redis.conf <span class="token comment"># 根据需要修改配置</span></pre></td></tr><tr><td data-num="17"></td><td><pre>redis-server redis.conf</pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token function">ps</span> aux <span class="token operator">|</span> <span class="token function">grep</span> redis</pre></td></tr></table></figure><p>redis.conf 配置项示例：</p><figure class="highlight properties"><figcaption data-lang=".properties"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 监听地址，学习时可以放开允许所有 IP</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token attr-name">bind</span> <span class="token attr-value">0.0.0.0</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># 后台运行，默认为前台运行</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token attr-name">daemonize</span> <span class="token attr-value">yes</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 设置 redis 密码</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token attr-name">requirepass</span> <span class="token attr-value">foobared</span></pre></td></tr></table></figure></li><li><p>Redis 开机自启</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 编辑启动脚本</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">vi</span> /etc/systemd/system/redis.service</pre></td></tr><tr><td data-num="3"></td><td><pre>systemctl daemon-reload <span class="token comment"># 重载系统服务</span></pre></td></tr><tr><td data-num="4"></td><td><pre>systemctl start redis <span class="token comment"># 启动 redis</span></pre></td></tr><tr><td data-num="5"></td><td><pre>systemctl status redis <span class="token comment"># 查看 redis 状态</span></pre></td></tr><tr><td data-num="6"></td><td><pre>systemctl stop redis <span class="token comment"># 停止 redis</span></pre></td></tr><tr><td data-num="7"></td><td><pre>systemctl <span class="token builtin class-name">enable</span> redis <span class="token comment"># 允许 redis 开机自启</span></pre></td></tr></table></figure><p>redis.service 启动脚本内容示例如下：</p><figure class="highlight properties"><figcaption data-lang=".properties"></figcaption><table><tr><td data-num="1"></td><td><pre>[Unit]</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token attr-name">Description</span><span class="token punctuation">=</span><span class="token attr-value">redis-server</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token attr-name">After</span><span class="token punctuation">=</span><span class="token attr-value">network.target</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>[Service]</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token attr-name">Type</span><span class="token punctuation">=</span><span class="token attr-value">forking</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token attr-name">ExecStart</span><span class="token punctuation">=</span><span class="token attr-value">/usr/local/bin/redis-server /usr/local/redis/redis-6.2.6/redis.conf</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token attr-name">PrivateTmp</span><span class="token punctuation">=</span><span class="token attr-value">true</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>[Install]</pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token attr-name">WantedBy</span><span class="token punctuation">=</span><span class="token attr-value">multi-user.target</span></pre></td></tr></table></figure><p>注：</p><ul><li>如启动不成功，尝试检查配置文件内容是否正确，端口是否被占用。</li></ul></li></ol><h4 id="redis-连接"><a class="anchor" href="#redis-连接">#</a> Redis 连接</h4><ol><li><p>命令行客户端：redis-cli</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token builtin class-name">cd</span> ~ <span class="token comment"># 任意位置</span></pre></td></tr><tr><td data-num="2"></td><td><pre>redis-cli -h <span class="token number">127.0</span>.0.1 -p <span class="token number">6379</span> <span class="token comment"># 语法：redis-cli [options] [commonds]</span></pre></td></tr><tr><td data-num="3"></td><td><pre>AUTH foobared <span class="token comment"># 语法：AUTH [username] password</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token builtin class-name">set</span> name chinmoku</pre></td></tr><tr><td data-num="5"></td><td><pre>get name</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token builtin class-name">exit</span> <span class="token comment"># 退出</span></pre></td></tr></table></figure></li><li><p>图形化客户端：RedisDesktopManager</p><p>源码地址：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3VnbGlkZS9SZWRpc0Rlc2t0b3BNYW5hZ2VyL3JlbGVhc2Vz">https://github.com/uglide/RedisDesktopManager/releases</span></p><p>源码下载后需要手动编译，也可以<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2xld29yay9SZWRpc0Rlc2t0b3BNYW5hZ2VyLVdpbmRvd3MvcmVsZWFzZXM=">点击此处</span>下载对应的编译版本。</p><p>注：</p><ul><li><p>通过 windows 连接服务器的 redis 服务，需要注意对应的防火墙、安全组等是否开放。</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 添加防火墙指定端口</span></pre></td></tr><tr><td data-num="2"></td><td><pre>firewall-cmd --add-port<span class="token operator">=</span><span class="token number">6379</span>/tcp --permanent</pre></td></tr><tr><td data-num="3"></td><td><pre>firewall-cmd --reload <span class="token comment"># 重载生效</span></pre></td></tr></table></figure></li></ul></li></ol><h3 id="redis-命令"><a class="anchor" href="#redis-命令">#</a> Redis 命令</h3><h4 id="数据结构"><a class="anchor" href="#数据结构">#</a> 数据结构</h4><p>Redis 是一个以 <code>key-value</code> 形式存储数据的数据库，key 一般是 String 类型，但 value 类型则存在多种：</p><p>基本数据类型：</p><ul><li><p>String - 存储字符串，例如： <code>hello world</code> 。</p></li><li><p>Hash - 存储较为复杂的数据结构，例如： <code>&#123;name: &quot;Chinmoku&quot;, age: 20&#125;</code> 。</p></li><li><p>List - 存储数组列表，例如： <code>[A, B, C, C]</code> 。</p></li><li><p>Set - 存储元素不可重复的数组，例如： <code>&#123;A, B, C&#125;</code> 。</p></li><li><p>SortedSet - 存储有序的，且元素不可重复的数组，例如： <code>&#123;A: 1, B: 2, C: 3&#125;</code> 。</p></li></ul><p>特殊类型：</p><ul><li>GEO</li><li>BitMap</li><li>HyperLog</li></ul><h4 id="通用命令"><a class="anchor" href="#通用命令">#</a> 通用命令</h4><div class="note danger no-icon"><p>Redis 命令参考：<span class="exturl" data-url="aHR0cHM6Ly9yZWRpcy5pby9jb21tYW5kcw==">https://redis.io/commands</span></p><p>或者通过 <code>help [commands]</code> 即可查看相关命令用法。</p></div><p>Redis 通用命令示例：</p><ol><li><p>KEYS pattern 查询以字母 a 开头的 key。</p><blockquote><p>由于 redis 是单线程执行，当数据量较大时，会导致业务阻塞，不建议在生产环境下使用。</p></blockquote></li><li><p>DEL key [key ...] 删除指定的一个或多个 key。</p></li><li><p>EXISTS key [key ...] 判断指定的 key 是否存在。</p></li><li><p>EXPIRE key seconds 设置 key 的有效期。</p></li><li><p>TTL key 获取 key 的有效期。</p><blockquote><p>如不指定，则默认为 -1 表示永久有效。如果 key 不存在，查询其有效期则会返回 <code>-2</code> 。</p></blockquote></li></ol><h4 id="string-类型"><a class="anchor" href="#string-类型">#</a> String 类型</h4><p>String 类型是 redis 中最简单的数据类型，但其 value 根据字符串的不同格式，又可以分为三类：</p><ul><li>string 普通字符串。</li><li>int 整数类型，可以进行自增、自减等操作。</li><li>float 浮点类型，可以进行自增、自减等操作。</li></ul><blockquote><p>不论是哪种格式的字符串类型，其底层都是使用字节数组进行存储的，只是采用的编码方式不同而已。字符串类型的最大空间不能超过 512m。</p></blockquote><p>String 类型常见命令：</p><ol><li>SET key value</li><li>GET key</li><li>MSET key value [key value ...] 批量插入。</li><li>MGET key [key ...] 批量获取。</li><li>INCR key 设置某个 key 自增。</li><li>INCRBY key increment 自增幅度。</li><li>INCRBYFLOAT key increment 设置浮点数自增。</li><li>SETNX key value 当 key 不存在时，才进行插入。</li><li>SETEX key seconds value 设置指定 key 的有效期。</li></ol><blockquote><p>PS. Redis 中 key 的层级格式：</p><p>在业务使用过程中，我们定义的 key 要求全局唯一，往往是以对象的 ID 来表示，但当 redis 中存在不同类型的对象时，key 重复的几率会相应地增加，并且难以对不同的 key 进行区分。因此，在 redis 使用过程中，我们通常会对 redis 的 key 格式做出一定的限制，但这种限制并不是强制的，企业或开发者可以自行设计，例如： <code>项目名:业务名:id</code> 。</p><p>此外，这种 key 的设计方式，在部分 redis 客户端中，也可以形成不同的层级显示。</p></blockquote><h4 id="hash-类型"><a class="anchor" href="#hash-类型">#</a> Hash 类型</h4><p>Hash 类型，也叫散列，其 value 是一个无序字典，类似于 java 中的 HashMap 结构。</p><p>Hash 类型常见命令：</p><ol><li>HSET key field value [field value ...]</li><li>HGET key field</li><li>HMSET key field value [field value ...] 设置多个 Hash 字段。</li><li>HMGET key field [field ...] 获取多个 Hash 字段。</li><li>HGETALL key 获取 key 对应的所有 Hash 键值对。</li><li>HKEYS key 获取 key 对应的所有 Hash 键。</li><li>HVALS key 获取 key 对应的所有 Hash 值。</li><li>HINCRBY key field increment 设置 Hash 中某一字段按步长自增。</li><li>HSETNX key field value 当某一 key 对应 Hash 的字段不存在时，才进行赋值。</li></ol><p>🎈 <strong>为什么 redis 中推荐使用 Hash 而非 String 来存储 JSON 的数据结构？</strong></p><p>在 Redis 中使用 String 的数据结构来存储 JSON，其实是将 JSON 字符串序列化之后再进行存储的，当需要获取 JSON 内部的某个字段时，必须获取整个字符串内容，而使用 Hash 结构存储 JSON 数据时，则会将 JSON 中的每个字段独立存储，它更加方便对 JSON 中的单个字段做 CRUD 操作。</p><h4 id="list-类型"><a class="anchor" href="#list-类型">#</a> List 类型</h4><p>Redis 中的 List 可以看做是一个双向链表，既可以支持正向检索，也支持反向检索。与 Java 中的 LinkedList 相似，它也具有如下特征：</p><ul><li>有序。</li><li>可重复。</li><li>插入和删除效率高。</li><li>查询效率较低。</li></ul><p>List 类型常见命令：</p><ol><li>LPUSH key element [element ...] 向数组左侧追加元素。</li></ol><blockquote><p>使用 LPUSH 后，其放入和取出元素的顺序是相反的，与之对应的这是 RPUSH。</p></blockquote><ol start="2"><li><p>LPOP key [count] 从左侧开始获取并移除数组中的元素。</p></li><li><p>LRANGE key start stop 获取数组中指定下标范围内的元素。</p></li><li><p>BLPOP key [key ...] timeout 从左侧开始阻塞式地获取并移除数组中的元素。</p><blockquote><p>当 BLPOP 无法获取到元素时，会等待指定的时间，若等待期间可以获取到元素，则直接取出并返回；如等待时间过期仍未获取到元素，则返回 <code>nil</code> 。</p></blockquote></li></ol><p>🎈 <strong>如何利用 Redis 的 List 数据结构来模拟栈、队列及阻塞队列？</strong></p><p>使用 LPUSH 和 LPOP，或 RPUSH 和 RPOP，都从左侧或都从右侧存入和取出元素，则可以模拟栈的数据结构；相反地，左侧存入右侧取出，或右侧存入左侧取出，则可以模拟队列的数据结构。而对于阻塞队列，则是在队列特征基础上，取出元素时，使用 BLOPO 或 BRPOP 即可。</p><h4 id="set-类型"><a class="anchor" href="#set-类型">#</a> Set 类型</h4><p>Redis 中的 Set 结构与 Java 中的 HashSet 相似，它也具备与 HashSet 类似的特征：</p><ul><li>无序。</li><li>不可重复。</li><li>查询效率高。</li><li>支持交集、并集、差集等。</li></ul><p>Set 类型常见命令：</p><ol><li>SADD key member [member ...] 向 Set 中插入元素。</li><li>SREM key member [member ...] 移除 Set 中的元素。</li><li>SCARD key 查询 Set 中元素数量。</li><li>SISMEMBER key member 判断 Set 中是否存在某元素。</li><li>SMEMBERS key 获取 Set 中所有元素。</li><li>SINTER key [key ...] 交集。</li><li>SDIFF key [key ...] 差集。</li><li>SUNION key [key ...] 并集。</li></ol><h4 id="sortedset-类型"><a class="anchor" href="#sortedset-类型">#</a> SortedSet 类型</h4><p>Redis 中的 SortedSet 是一个可排序的 Set 集合。SortedSet 中每一个元素都带有一个 score 属性，可以基于 score 属性对元素进行排序，其底层实现是一个跳表（SkipList）加 Hash 表。SortedSet 具备如下特征：</p><ul><li>可排序。</li><li>不重复。</li><li>查询效率高。</li></ul><p>SortedSet 类型常见命令：</p><ol><li>ZADD key</li><li>ZREM key member [member ...]</li><li>ZSCORE key member 获取某元素的 score 值。</li><li>ZRANK key member 获取某元素在该集合中的排名。</li><li>ZCARD key</li><li>ZCOUNT key min max 统计指定 score 范围内的元素个数。</li><li>ZINCRBY key increment member 使集合中指定元素按步长自增。</li><li>ZRANGE key min max 获取指定排名范围的元素。</li><li>ZRANGEBYSCORE key min max 获取指定 score 范围的元素。</li><li>ZINTER numkeys key [key ...] 交集。</li><li>ZDIFF numkeys key [key ...] 差集。</li><li>ZUNION numkeys key [key ...] 并集。</li></ol><blockquote><p>SortedSet 查询排序默认采用升序，如需使用降序，只需在字母 Z 之后添加 REV 即可，如 ZREVRANGE。</p></blockquote><h3 id="java-客户端"><a class="anchor" href="#java-客户端">#</a> Java 客户端</h3><p>Redis 官方推荐如下三款客户端产品：</p><ol><li>Jedis，其特点是学习成本低，基本使用 redis 命令作为 API 方法名。但基于 Jedis 的连接无法保证线程安全，在多线程环境下需要基于连接池来使用。</li><li>Lettuce，基于 Netty 实现，支持同步、异步和响应式编程，并且是线程安全的，支持 Redis 哨兵模式、集群模式和管道模式。</li><li>Redisson，是一个基于 Redis 实现的分布式、可伸缩的 Java 数据结构集合，包含了诸如 Map、Queue、Lock、Semaphere、AtomicLong 等强大功能。</li></ol><blockquote><p>出于对本文篇幅的考虑，此处仅对 Jedis 做扩展介绍，如对其他客户端产品感兴趣，可自行了解。</p><p>PS. 综合各种 Redis 客户端的优缺点，也可以考虑使用 Spring 集成的工具包 <code>Spring Data Redis</code> 。</p></blockquote><h4 id="jedis"><a class="anchor" href="#jedis">#</a> Jedis</h4><p>项目地址：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3JlZGlzL2plZGlz">https://github.com/redis/jedis</span></p><p><strong>基本使用方式：</strong></p><ol><li><p>添加依赖： <code>redis.clients.jedis:4.1.1</code> 。</p></li><li><p>建立连接：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">private</span> <span class="token class-name">Jedis</span> jedis<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token annotation punctuation">@BeforeEach</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">void</span> <span class="token function">setUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    jedis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jedis</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span> <span class="token number">6379</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 建立连接</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    jedis<span class="token punctuation">.</span><span class="token function">auth</span><span class="token punctuation">(</span><span class="token string">"123456"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 密码</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    jedis<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 选择库</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure></li><li><p>测试使用：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Test</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token class-name">String</span> result <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"Chinmoku"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"result = "</span> <span class="token operator">+</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token class-name">String</span> name <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"name = "</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>类似地，其他 redis 相关操作调用的方法名称，也基本与 redis 命令相同。</p></blockquote></li><li><p>释放资源：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@AfterEach</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">void</span> <span class="token function">tearDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>jedis <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        jedis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure></li></ol><p><strong>Jedis 连接池：</strong></p><p>Jedis 本身是线程不安全的，并且频繁地创建和销毁连接会产生极大的性能消耗，因此在使用 Jedis 的过程中，不推荐使用 Jedis 直连，而建议实现连接池。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JedisConnectionFactory</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">JedisPool</span> jedisPoll<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    </pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">static</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token class-name">JedisPoolConfig</span> jedisPoolConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JedisPoolConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        jedisPoolConfig<span class="token punctuation">.</span><span class="token function">setMaxTotal</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 最大连接数</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        jedisPoolConfig<span class="token punctuation">.</span><span class="token function">setMaxIdle</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 最大空闲连接数</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        jedisPoolConfig<span class="token punctuation">.</span><span class="token function">setMinIdle</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 最小空闲连接数</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        jedisPoolConfig<span class="token punctuation">.</span><span class="token function">setMaxWaitMillis</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 最长等待时间</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        jedisPoll <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JedisPool</span><span class="token punctuation">(</span>jedisPoolConfig<span class="token punctuation">,</span> <span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span> <span class="token number">6379</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token string">"123456"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    </pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Jedis</span> <span class="token function">getJedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token keyword">return</span> jedisPool<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="springdataredis"><a class="anchor" href="#springdataredis">#</a> SpringDataRedis</h4><p>SpringData 是 Sring 中数据操作的模块，包含对各种数据库的集成，其中对 Redis 的集成模块即为 SpringDataRedis：</p><ul><li>提供了对不同 Redis 客户端的整合（Lettuce 和 Jedis）。</li><li>提供了 RedisTemplate 统一 API 来操作 Redis。</li><li>支持 Redis 的发布订阅模式。</li><li>支持 Redis 的哨兵模式和集群模式。</li><li>支持基于 Lettuce 的响应式编程。</li><li>支持基于 JDK、JSON、字符串、Spring 对象的数据序列号及反序列化。</li><li>支持基于 Redis 的 JDKCollection 实现。</li></ul><blockquote><p>SpringDataRedis 官方文档：<span class="exturl" data-url="aHR0cHM6Ly9zcHJpbmcuaW8vcHJvamVjdHMvc3ByaW5nLWRhdGEtcmVkaXM=">https://spring.io/projects/spring-data-redis</span></p></blockquote><p>SpringDataRedis 提供了 RedisTemplate 工具类，其中封装了各种对 Redis 的操作，并且将不同数据类型的操作 API 封装到了不同的类型中：</p><table><thead><tr><th>API</th><th>返回值类型</th><th>说明</th></tr></thead><tbody><tr><td>redisTemplate.opsForValue()</td><td>valueOperations</td><td>操作 String 类型数据</td></tr><tr><td>redisTemplate.opsForHash()</td><td>HashOperations</td><td>操作 Hash 类型数据</td></tr><tr><td>redisTemplate.opsForList()</td><td>ListOperations</td><td>操作 List 类型数据</td></tr><tr><td>redisTemplate.opsForSet()</td><td>SetOperations</td><td>操作 Set 类型数据</td></tr><tr><td>redisTemplate.opsForZSet()</td><td>ZSetOperations</td><td>操作 SortedSet 类型数据</td></tr><tr><td>redisTemplate</td><td></td><td>通用命令</td></tr></tbody></table><p><strong>基本使用方式：</strong></p><ol><li><p>添加依赖：</p><ul><li>Redis 依赖： <code>org.springframework.boot.spring-boot-starter-data-redis:2.6.2</code> 。</li><li>连接池依赖： <code>org.apache.commons.commons-pool2:2.11.1</code> 。</li></ul></li><li><p>配置文件：</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">spring</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">redis</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token key atrule">host</span><span class="token punctuation">:</span> 127.0.0.1</pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6379</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token number">123456</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment"># 默认使用 lettuce，如需使用 jedis，需引入对应依赖</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token key atrule">lettuce</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>      <span class="token key atrule">pool</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token key atrule">max-active</span><span class="token punctuation">:</span> <span class="token number">8</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token key atrule">max-idle</span><span class="token punctuation">:</span> <span class="token number">8</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token key atrule">min-idle</span><span class="token punctuation">:</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token key atrule">max-wait</span><span class="token punctuation">:</span> <span class="token number">100</span> <span class="token comment"># 连接等待时间</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">600</span> <span class="token comment"># 连接超时时间</span></pre></td></tr></table></figure></li><li><p>注入 RedisTemplate 并使用：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Autowired</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token annotation punctuation">@Test</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"chinmoku"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 插入</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token class-name">Object</span> name <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 读取</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"name = "</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token comment">// 存储对象</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"user:1"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">"chinmoku"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">)</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"user:1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"user = "</span> <span class="token operator">+</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure></li></ol><p><strong>SpringDataRedis 序列化方式：</strong></p><p>SpringDataRedis 可以接收任意 Object 作为值写入 Redis，但在写入之前都会将其序列化为字节形式，并且默认采用 JdkSerializationRedisSerializer，这会导致可读性差和不必要的内存占用的问题。因此，我们可以对 SpringDataRedis 进行个性化实现：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * SpringDataRedis 自定义序列化方式</pre></td></tr><tr><td data-num="3"></td><td><pre> */</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token annotation punctuation">@Configuation</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisConfig</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    </pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token annotation punctuation">@Bean</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> <span class="token function">redisTemplate</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span> redisConnectionFactory<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UnknownHostException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> redisTemplate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token comment">// 设置连接工厂</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        redisTemplate<span class="token punctuation">.</span><span class="token function">setConnectionFactory</span><span class="token punctuation">(</span>redisConnectionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token comment">// 设置序列化工具（注：使用 json 序列化需要引入 jackson-databind 依赖）</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token class-name">GenericJackson2JsonRedisSerializer</span> jsonRedisSerializer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GenericJackson2JsonRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token comment">//key 和 hashKey 采用 string 序列化</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        redisTemplate<span class="token punctuation">.</span><span class="token function">setKeySerializer</span><span class="token punctuation">(</span><span class="token class-name">RedisSerializer</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        redisTemplate<span class="token punctuation">.</span><span class="token function">setHashKeySerializer</span><span class="token punctuation">(</span><span class="token class-name">RedisSerializer</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token comment">//value 和 hashValue 采用 json 序列化</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        redisTemplate<span class="token punctuation">.</span><span class="token function">setValueSerializer</span><span class="token punctuation">(</span>jsonRedisSerializer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        redisTemplate<span class="token punctuation">.</span><span class="token function">setHashValueSerializer</span><span class="token punctuation">(</span>jsonRedisSerializer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>如上示例，当存储 Java 对象时，我们可以使用 JSON 序列化器，自动实现对象的序列化和反序列化，但这种方式会在 Redis 中额外存储一个 <code>@class</code> 字段，用于指定序列化和反序列化对象所属的类，这也会在一定程度上造成不必要的空间浪费。</p><p>为了节省空间，在编码过程中，我们通常推荐在存储数据之前，手动进行对象的序列化处理，然后再通过 String 序列化方式进行存储；取值时，再通过程序判断进行反序列化。为此，对于 String 类型的数据存储，SpringDataRedis 提供了一个 StringRedisTemplate 类，它默认即采用 String 序列化方式：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Autowired</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">// JSON 工具（也可以使用其他序列化工具，如 fastjson 等）</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ObjectMapper</span> mapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token annotation punctuation">@Test</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">void</span> <span class="token function">testStringTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">JsonProcessingException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">"chinmoku"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token comment">// 手动序列化</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token class-name">String</span> json <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"user:1"</span><span class="token punctuation">,</span> json<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    </pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token class-name">String</span> value <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"user:1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token class-name">User</span> u <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">readVal</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 反序列化</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"user = "</span> <span class="token operator">+</span> u<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><strong>RedisTemplate 操作 Hash：</strong></p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Test</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">void</span> <span class="token function">testHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"user:2"</span><span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"zhangsan"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"user:2"</span><span class="token punctuation">,</span> <span class="token string">"age"</span><span class="token punctuation">,</span> <span class="token string">"21"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> entries <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span><span class="token string">"user:2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"entries = "</span> <span class="token operator">+</span> entries<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="缓存问题及解决方案"><a class="anchor" href="#缓存问题及解决方案">#</a> 缓存问题及解决方案</h3><h4 id="缓存更新策略"><a class="anchor" href="#缓存更新策略">#</a> 缓存更新策略</h4><p>所谓缓存，就是数据交换的缓冲区，是存储数据的地方，一般读写性能较高。</p><p>操作缓存和数据库时，需要考虑如下三个问题：</p><ol><li><p>更新数据库时，对于缓存数据，是应当执行更新操作还是删除操作？</p><ul><li>更新缓存：每次更新数据库都更新缓存，容易产生较多的无效写操作。</li><li>删除缓存：更新数据库时使缓存失效，查询数据库时再更新缓存（推荐）。</li></ul></li><li><p>如何保证缓存和数据库操作同时成功或同时失败？</p><ul><li>单系统环境下，需要将缓存和数据库操作放在同一个事务中。</li><li>分布式系统环境下，可以利用 TCC 等分布式事务方案。</li></ul></li><li><p>执行数据操作时，先操作缓存还是数据库？</p><p><img data-src="https://img.xfc-exclave.com/2022/03/d1f36fa6ee35a9c1a98578527399f1e21647090860.png" alt="redis-cache"></p><p>如上图所示，不论是先操作缓存还是先操作数据库，在并发环境下，都有可能出现数据不一致问题。但通常而言，缓存操作效率远高于数据库操作效率，因此先操作数据库，再删除缓存出现数据不一致的概率较低，但也仅限于概率较低而已，仍存在数据不一致的风险。</p></li></ol><p><strong>扩展：</strong></p><p>基于数据库与缓存之间的数据不一致问题，目前有如下几种较为常见的解决方案：</p><ol><li><p>延时双删</p><p>所谓的延时双删，可以通过如下伪代码进行表示：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> data<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    redis<span class="token punctuation">.</span><span class="token function">delKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    db<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    redis<span class="token punctuation">.</span><span class="token function">delKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这里的延时，主要是为了确保在进行第二次删除之前，其他交叉线程已经完成数据库查询和更新缓存操作，如下图所示：</p><p><img data-src="https://img.xfc-exclave.com/2022/03/a3ba9a6e4004b2806121e1c35cb7be771647095968.png" alt="redis-cache-sleep"></p><p>在延时双删过程中，如果存在其他线程对缓存进行更新，那么该更新缓存的线程所得数据仍为旧数据，但新的线程访问时，能保证得到的数据是新的数据。</p></li><li><p>异步更新缓存</p><p>TODO</p><blockquote><p>值得注意的是，在保证 Redis 性能的前提下，数据库与缓存之间的数据其实是无法保证绝对一致的，我们通常所说的缓存一致性，往往需要将实际业务场景纳入考虑范围，进行综合考虑。</p></blockquote></li></ol><h4 id="缓存穿透"><a class="anchor" href="#缓存穿透">#</a> 缓存穿透</h4><p>缓存穿透是指客户端请求的数据在缓存和数据库中均不存在，这样就使得缓存永远无法生效，导致请求始终都会直接访问数据库，从而影响服务性能。</p><p>针对缓存穿透，有如下两种常见解决方案：</p><ol><li><p>缓存空对象：即当数据库中不存在该数据时，则向缓存中存入空对象，同时设置较短的过期时间。</p><p>优点：实现简单，方便维护。</p><p>缺点：</p><ul><li>占用不必要的内存。</li><li>可能造成短期数据不一致（针对这一缺点，可以在更新数据时同步更新到缓存）。</li></ul></li><li><p>布隆过滤</p><p>相关介绍可查阅<span class="exturl" data-url="aHR0cHM6Ly9iYWlrZS5iYWlkdS5jb20vaXRlbS8lRTUlQjglODMlRTklOUElODYlRTglQkYlODclRTYlQkIlQTQlRTUlOTklQTg=">布隆过滤器_百度百科</span>。</p><p>优点：内存占用少，没有多余的 key。</p><p>缺点：</p><ul><li>实现复杂。</li><li>存在误判的可能。</li></ul></li></ol><blockquote><p>除此之外，在业务上我们也应当做相应的控制，例如增加 ID 复杂度、做好数据的基础格式校验、加强用户权限校验、做好热点数据限流等。</p></blockquote><h4 id="缓存雪崩"><a class="anchor" href="#缓存雪崩">#</a> 缓存雪崩</h4><p>缓存雪崩是指在同一时段内的缓存 key 同时失效或者 Redis 服务宕机，导致大量请求直接到达数据库，给数据库带来巨大压力。</p><p>针对缓存雪崩，有如下几种常见解决方案：</p><ol><li>给不同 key 的 TTL 添加随机值，尽量分散缓存的过期时间。</li><li>利用 Redis 集群提高服务的可用性（以解决 Redis 服务宕机问题）。</li><li>给缓存服务添加降级限流策略，做好服务容错。</li><li>给业务添加多级缓存。</li></ol><h4 id="缓存击穿"><a class="anchor" href="#缓存击穿">#</a> 缓存击穿</h4><p>缓存击穿也被称为热点 key 问题，就是一个被高并发访问并且缓存重建业务较为复杂的 key 突然失效，大量请求瞬间访问到数据库，导致数据库承受巨大压力。</p><p>针对缓存击穿，有如下几种常见解决方案：</p><ol><li><p>互斥锁</p><p>重建数据时，进行加锁，获取到锁的线程才进行数据重建，其他线程进行一定的等待和重试。这种方案由于需要线程等待，性能相对较差。</p></li><li><p>逻辑过期</p><p>不采用 Redis 提供的 TTL，而是自定义一个逻辑过期字段用于记录过期时间，当程序通过该字段判断数据过期时，则使用互斥锁开启一个新的线程，用该线程来执行更新缓存数据操作，更新完数据后，释放锁。其他未获取到互斥锁时，直接返回缓存中的旧数据。</p></li></ol><h4 id="代码实现"><a class="anchor" href="#代码实现">#</a> 代码实现</h4><blockquote><p>为了更加方便开发过程中，对解决缓存穿透和缓存击穿等问题整理思路，此处引用一份黑马教学编写的示例代码，<span class="exturl" data-url="aHR0cHM6Ly9naXRlZS5jb20vaHV5aTYxMi9obS1kaWFucGluZy9ibG9iL21hc3Rlci9zcmMvbWFpbi9qYXZhL2NvbS9obWRwL3V0aWxzL0NhY2hlQ2xpZW50LmphdmE=">点击此处</span>可以查看源代码位置。</p></blockquote><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Slf4j</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@Component</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CacheClient</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ExecutorService</span> CACHE_REBUILD_EXECUTOR <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">CacheClient</span><span class="token punctuation">(</span><span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>stringRedisTemplate <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">,</span> <span class="token class-name">Long</span> time<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span> time<span class="token punctuation">,</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setWithLogicalExpire</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">,</span> <span class="token class-name">Long</span> time<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token comment">// 设置逻辑过期</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token class-name">RedisData</span> redisData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        redisData<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        redisData<span class="token punctuation">.</span><span class="token function">setExpireTime</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">plusSeconds</span><span class="token punctuation">(</span>unit<span class="token punctuation">.</span><span class="token function">toSeconds</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token comment">// 写入 Redis</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>redisData<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">,</span>ID<span class="token punctuation">></span></span> <span class="token class-name">R</span> <span class="token function">queryWithPassThrough</span><span class="token punctuation">(</span><span class="token class-name">String</span> keyPrefix<span class="token punctuation">,</span> <span class="token class-name">ID</span> id<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">></span></span> type<span class="token punctuation">,</span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span>ID<span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">></span></span> dbFallback<span class="token punctuation">,</span> <span class="token class-name">Long</span> time<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token class-name">String</span> key <span class="token operator">=</span> keyPrefix <span class="token operator">+</span> id<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token comment">// 1. 从 redis 查询商铺缓存</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token class-name">String</span> json <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token comment">// 2. 判断是否存在</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>            <span class="token comment">// 3. 存在，直接返回</span></pre></td></tr><tr><td data-num="33"></td><td><pre>            <span class="token keyword">return</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token comment">// 判断命中的是否是空值</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>json <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>            <span class="token comment">// 返回一个错误信息</span></pre></td></tr><tr><td data-num="38"></td><td><pre>            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token comment">// 4. 不存在，根据 id 查询数据库</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token class-name">R</span> r <span class="token operator">=</span> dbFallback<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        <span class="token comment">// 5. 不存在，返回错误</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>            <span class="token comment">// 将空值写入 redis</span></pre></td></tr><tr><td data-num="46"></td><td><pre>            stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> CACHE_NULL_TTL<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MINUTES<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>            <span class="token comment">// 返回错误信息</span></pre></td></tr><tr><td data-num="48"></td><td><pre>            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>        <span class="token comment">// 6. 存在，写入 redis</span></pre></td></tr><tr><td data-num="51"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> r<span class="token punctuation">,</span> time<span class="token punctuation">,</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>        <span class="token keyword">return</span> r<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="54"></td><td><pre></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">,</span> ID<span class="token punctuation">></span></span> <span class="token class-name">R</span> <span class="token function">queryWithLogicalExpire</span><span class="token punctuation">(</span><span class="token class-name">String</span> keyPrefix<span class="token punctuation">,</span> <span class="token class-name">ID</span> id<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">></span></span> type<span class="token punctuation">,</span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span>ID<span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">></span></span> dbFallback<span class="token punctuation">,</span> <span class="token class-name">Long</span> time<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>        <span class="token class-name">String</span> key <span class="token operator">=</span> keyPrefix <span class="token operator">+</span> id<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>        <span class="token comment">// 1. 从 redis 查询商铺缓存</span></pre></td></tr><tr><td data-num="58"></td><td><pre>        <span class="token class-name">String</span> json <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>        <span class="token comment">// 2. 判断是否存在</span></pre></td></tr><tr><td data-num="60"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>            <span class="token comment">// 3. 存在，直接返回</span></pre></td></tr><tr><td data-num="62"></td><td><pre>            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>        <span class="token comment">// 4. 命中，需要先把 json 反序列化为对象</span></pre></td></tr><tr><td data-num="65"></td><td><pre>        <span class="token class-name">RedisData</span> redisData <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">RedisData</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>        <span class="token class-name">R</span> r <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">JSONObject</span><span class="token punctuation">)</span> redisData<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>        <span class="token class-name">LocalDateTime</span> expireTime <span class="token operator">=</span> redisData<span class="token punctuation">.</span><span class="token function">getExpireTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>        <span class="token comment">// 5. 判断是否过期</span></pre></td></tr><tr><td data-num="69"></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span>expireTime<span class="token punctuation">.</span><span class="token function">isAfter</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>            <span class="token comment">// 5.1. 未过期，直接返回店铺信息</span></pre></td></tr><tr><td data-num="71"></td><td><pre>            <span class="token keyword">return</span> r<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>        <span class="token comment">// 5.2. 已过期，需要缓存重建</span></pre></td></tr><tr><td data-num="74"></td><td><pre>        <span class="token comment">// 6. 缓存重建</span></pre></td></tr><tr><td data-num="75"></td><td><pre>        <span class="token comment">// 6.1. 获取互斥锁</span></pre></td></tr><tr><td data-num="76"></td><td><pre>        <span class="token class-name">String</span> lockKey <span class="token operator">=</span> LOCK_SHOP_KEY <span class="token operator">+</span> id<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>        <span class="token keyword">boolean</span> isLock <span class="token operator">=</span> <span class="token function">tryLock</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>        <span class="token comment">// 6.2. 判断是否获取锁成功</span></pre></td></tr><tr><td data-num="79"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>isLock<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>            <span class="token comment">// 6.3. 成功，开启独立线程，实现缓存重建</span></pre></td></tr><tr><td data-num="81"></td><td><pre>            CACHE_REBUILD_EXECUTOR<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>                    <span class="token comment">// 查询数据库</span></pre></td></tr><tr><td data-num="84"></td><td><pre>                    <span class="token class-name">R</span> newR <span class="token operator">=</span> dbFallback<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>                    <span class="token comment">// 重建缓存</span></pre></td></tr><tr><td data-num="86"></td><td><pre>                    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setWithLogicalExpire</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> newR<span class="token punctuation">,</span> time<span class="token punctuation">,</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="88"></td><td><pre>                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="89"></td><td><pre>                <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="90"></td><td><pre>                    <span class="token comment">// 释放锁</span></pre></td></tr><tr><td data-num="91"></td><td><pre>                    <span class="token function">unlock</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="92"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="93"></td><td><pre>            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="94"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="95"></td><td><pre>        <span class="token comment">// 6.4. 返回过期的商铺信息</span></pre></td></tr><tr><td data-num="96"></td><td><pre>        <span class="token keyword">return</span> r<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="97"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="98"></td><td><pre></pre></td></tr><tr><td data-num="99"></td><td><pre>    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">,</span> ID<span class="token punctuation">></span></span> <span class="token class-name">R</span> <span class="token function">queryWithMutex</span><span class="token punctuation">(</span><span class="token class-name">String</span> keyPrefix<span class="token punctuation">,</span> <span class="token class-name">ID</span> id<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">></span></span> type<span class="token punctuation">,</span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span>ID<span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">></span></span> dbFallback<span class="token punctuation">,</span> <span class="token class-name">Long</span> time<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="100"></td><td><pre>        <span class="token class-name">String</span> key <span class="token operator">=</span> keyPrefix <span class="token operator">+</span> id<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="101"></td><td><pre>        <span class="token comment">// 1. 从 redis 查询商铺缓存</span></pre></td></tr><tr><td data-num="102"></td><td><pre>        <span class="token class-name">String</span> shopJson <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="103"></td><td><pre>        <span class="token comment">// 2. 判断是否存在</span></pre></td></tr><tr><td data-num="104"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>shopJson<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="105"></td><td><pre>            <span class="token comment">// 3. 存在，直接返回</span></pre></td></tr><tr><td data-num="106"></td><td><pre>            <span class="token keyword">return</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>shopJson<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="107"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="108"></td><td><pre>        <span class="token comment">// 判断命中的是否是空值</span></pre></td></tr><tr><td data-num="109"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>shopJson <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="110"></td><td><pre>            <span class="token comment">// 返回一个错误信息</span></pre></td></tr><tr><td data-num="111"></td><td><pre>            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="112"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="113"></td><td><pre></pre></td></tr><tr><td data-num="114"></td><td><pre>        <span class="token comment">// 4. 实现缓存重建</span></pre></td></tr><tr><td data-num="115"></td><td><pre>        <span class="token comment">// 4.1. 获取互斥锁</span></pre></td></tr><tr><td data-num="116"></td><td><pre>        <span class="token class-name">String</span> lockKey <span class="token operator">=</span> LOCK_SHOP_KEY <span class="token operator">+</span> id<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="117"></td><td><pre>        <span class="token class-name">R</span> r <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="118"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="119"></td><td><pre>            <span class="token keyword">boolean</span> isLock <span class="token operator">=</span> <span class="token function">tryLock</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="120"></td><td><pre>            <span class="token comment">// 4.2. 判断是否获取成功</span></pre></td></tr><tr><td data-num="121"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isLock<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="122"></td><td><pre>                <span class="token comment">// 4.3. 获取锁失败，休眠并重试</span></pre></td></tr><tr><td data-num="123"></td><td><pre>                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="124"></td><td><pre>                <span class="token keyword">return</span> <span class="token function">queryWithMutex</span><span class="token punctuation">(</span>keyPrefix<span class="token punctuation">,</span> id<span class="token punctuation">,</span> type<span class="token punctuation">,</span> dbFallback<span class="token punctuation">,</span> time<span class="token punctuation">,</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="125"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="126"></td><td><pre>            <span class="token comment">// 4.4. 获取锁成功，根据 id 查询数据库</span></pre></td></tr><tr><td data-num="127"></td><td><pre>            r <span class="token operator">=</span> dbFallback<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="128"></td><td><pre>            <span class="token comment">// 5. 不存在，返回错误</span></pre></td></tr><tr><td data-num="129"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="130"></td><td><pre>                <span class="token comment">// 将空值写入 redis</span></pre></td></tr><tr><td data-num="131"></td><td><pre>                stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> CACHE_NULL_TTL<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MINUTES<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="132"></td><td><pre>                <span class="token comment">// 返回错误信息</span></pre></td></tr><tr><td data-num="133"></td><td><pre>                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="134"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="135"></td><td><pre>            <span class="token comment">// 6. 存在，写入 redis</span></pre></td></tr><tr><td data-num="136"></td><td><pre>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> r<span class="token punctuation">,</span> time<span class="token punctuation">,</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="137"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="138"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="139"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="140"></td><td><pre>            <span class="token comment">// 7. 释放锁</span></pre></td></tr><tr><td data-num="141"></td><td><pre>            <span class="token function">unlock</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="142"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="143"></td><td><pre>        <span class="token comment">// 8. 返回</span></pre></td></tr><tr><td data-num="144"></td><td><pre>        <span class="token keyword">return</span> r<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="145"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="146"></td><td><pre></pre></td></tr><tr><td data-num="147"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="148"></td><td><pre>        <span class="token class-name">Boolean</span> flag <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="149"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">BooleanUtil</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="150"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="151"></td><td><pre></pre></td></tr><tr><td data-num="152"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="153"></td><td><pre>        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="154"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="155"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="redis-分布式锁"><a class="anchor" href="#redis-分布式锁">#</a> Redis 分布式锁</h3><p>所谓分布式锁，就是满足分布式系统或集群模式下多进程可见并互斥的锁。</p><p>分布式锁的核心是实现多线程之间的互斥，其实现方式常见有如下三种：</p><table><thead><tr><th></th><th>MySQL</th><th>Redis</th><th>Zookeeper</th></tr></thead><tbody><tr><td>互斥</td><td>利用 mysql 本身的互斥锁机制</td><td>利用 setnx 这样的互斥命令</td><td>利用节点唯一性和有序性实现互斥</td></tr><tr><td>高可用</td><td>好</td><td>好</td><td>好</td></tr><tr><td>高性能</td><td>一般</td><td>好</td><td>一般</td></tr><tr><td>安全性</td><td>断开连接，自动释放锁</td><td>利用超时机制，到期释放</td><td>临时节点，断开连接自动释放</td></tr></tbody></table><h4 id="基于-redis-实现分布式锁"><a class="anchor" href="#基于-redis-实现分布式锁">#</a> 基于 Redis 实现分布式锁</h4><p>基本实现思路：</p><ol><li><p>版本一：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 添加锁，利用 SETNX 的互斥性</span></pre></td></tr><tr><td data-num="2"></td><td><pre>SETNX lock thread-1</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># 添加锁过期时间，避免服务宕机导致死锁</span></pre></td></tr><tr><td data-num="4"></td><td><pre>EXPIRE lock <span class="token number">10</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 释放锁</span></pre></td></tr><tr><td data-num="6"></td><td><pre>DEL lock</pre></td></tr></table></figure></li><li><p>版本二：</p><p>在版本一中，由于命令逐条执行，考虑到在添加锁和设置锁过期时间之间仍有可能出现服务宕机的情况，因此我们还需要保证添加锁和设置锁过期时间这两个操作同时执行，具有原子性，因此需要对该方案进行升级：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 添加互斥锁并设置过期时间（原子性）</span></pre></td></tr><tr><td data-num="2"></td><td><pre>SET lock thread-1 EX <span class="token number">10</span> NX</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># 释放锁</span></pre></td></tr><tr><td data-num="4"></td><td><pre>DEL lock</pre></td></tr></table></figure></li><li><p>版本三：</p><p>基于版本二，基本上能够解决大部分并发情况，但在部分极端情况下，仍旧存在线程安全问题。主要表现在当获取到互斥锁的线程（Thread-A）执行时间超过 Redis TTL 过期时间，就会导致锁提前失效，在当前线程（Thread-A）未释放锁的情况下，此时进入新的线程（Thread-B）仍旧可以获取锁并执行业务逻辑，并且，在新的线程（Thread-B）执行过程中，先前获取到锁的线程（Thread-A）执行完业务逻辑后，就会释放线程（Thread-B）持有的锁。这样就会导致大量锁持有异常，从而引发业务灾难。</p><p>出现这样的问题，根本上是由于释放了非当前线程持有的锁导致的，因此，要解决这个问题，只需要在线程释放锁时，判断其释放的锁是否是当前线程持有即可。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 注：此段代码只用于方案说明，无法直接使用。</pre></td></tr><tr><td data-num="3"></td><td><pre> */</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token class-name">String</span> lockKeyName <span class="token operator">=</span> <span class="token string">"lock:user:192838"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token class-name">String</span> threadId <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"-"</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">// 获取锁</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token class-name">Boolean</span> success <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span>lockKeyName<span class="token punctuation">,</span> threadId<span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token class-name">TimeUtil</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">// 释放锁</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token class-name">String</span> id <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>lockKeyName<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment">// 校验锁拥有者</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">if</span> <span class="token punctuation">(</span>threadId<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token comment">// 释放锁</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    stringRedisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>lockKeyName<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure></li><li><p>最终版：</p><p>可以说即便是基于版本三，仍旧有出现线程安全问题的可能。考虑这样一种情况：当程序在释放锁时，先通过校验锁是否为当前线程持有，校验通过后，如果此时线程（Thread-A）突然发生阻塞（可能是由 JVM 垃圾回收导致），并且导致锁超时自动释放，此时在该线程阻塞的状态下，其他线程（Thread-B）就仍可以获取到锁，而当线程（Thread-A）阻塞通过后，由于它已经通过锁持有者校验，因此它将会进行释放锁，但此时它锁释放的锁，其实际上并非这个线程（Thread-A）所持有，从而再次引起版本三种提到的问题。</p><p>出现这样的问题，根本上是因为校验锁持有者的操作与释放锁操作之间存在时间空隙，导致锁被提前释放，因此，要解决这个问题，就需要保证校验锁持有者操作和释放锁操作同时执行，具有原子性。</p><p>这里推荐使用 <code>Lua 脚本</code> ，来保证一个原子性的操作，Lua 脚本基本语法，可参考 <span class="exturl" data-url="aHR0cHM6Ly93d3cucnVub29iLmNvbS9sdWEvbHVhLXR1dG9yaWFsLmh0bWw=">Lua 教程 | 菜鸟教程</span>。</p><p>Lua 脚本示例：</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 无参脚本</span></pre></td></tr><tr><td data-num="2"></td><td><pre>EVAL <span class="token string">"return redis.call('set', 'name', 'chinmoku')"</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># 带参脚本</span></pre></td></tr><tr><td data-num="4"></td><td><pre>EVAL <span class="token string">"return redis.call('set', KEYS[1], ARGV[1])"</span> <span class="token number">2</span> name chinmoku</pre></td></tr></table></figure><p>基于 Lua 脚本，我们可以通过如下方式来解决版本三中遗留的问题：</p><ul><li><p>编写释放锁的 Lua 脚本：</p><figure class="highlight lua"><figcaption data-lang="lua"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- FileName: unlock.lua</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">-- 校验锁拥有者</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">if</span> <span class="token punctuation">(</span>redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">then</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">-- 释放锁 del key</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">return</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'del'</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">end</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">return</span> <span class="token number">0</span></pre></td></tr></table></figure></li><li><p>在业务中执行 Lua 脚本：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name">String</span> lockKeyName <span class="token operator">=</span> <span class="token string">"lock:user:192838"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">String</span> threadId <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"-"</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">DefaultRedisScript</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">></span></span> UNLOCK_SCRIPT<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">static</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    UNLOCK_SCRIPT <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultRedisScript</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    UNLOCK_SCRIPT<span class="token punctuation">.</span><span class="token function">setLocation</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClassPathResource</span><span class="token punctuation">(</span><span class="token string">"unlock.lua"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    UNLOCK_SCRIPT<span class="token punctuation">.</span><span class="token function">setResultType</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    stringRedisTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>UNLOCK_SCRIPT<span class="token punctuation">,</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span>lockKeyName<span class="token punctuation">)</span><span class="token punctuation">,</span> threadId<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure></li></ul></li></ol><h4 id="redisson"><a class="anchor" href="#redisson">#</a> Redisson</h4><p>上述对 Redis 分布式锁进行了一系列方案探索，已经能够解决大部分并发场景下 Redis 分布式锁问题，但这种基于 SETNX 命令实现的分布式锁仍旧存在一些不足，例如：</p><ul><li>不可重入：同一个线程无法多次获取同一把锁。</li><li>不可重试：线程获取锁只尝试了一次，没有重试机制。</li><li>超时释放：锁超时释放虽然可以避免死锁，但如果业务执行耗时较长，仍旧会导致锁释放，因而存在安全隐患。</li><li>主从一致性：如果 Redis 提供主从集群，主从节点同步存在延迟时，如果主节点突然宕机，未能完成同步，则会导致数据不一致。</li></ul><p>鉴于如上问题，可以推荐一个更加使用的 Redis 解决方案，即 Redisson。</p><p>Redisson 是一个在 Redis 基础上实现扩展库，它不仅提供一系列分布式的 Java 常用对象，还提供了许多分布式服务，包括各种分布式锁的实现。</p><p>官网地址：<span class="exturl" data-url="aHR0cHM6Ly9yZWRpc3Nvbi5vcmc=">https://redisson.org</span></p><p>Github 首页：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3JlZGlzc29uL3JlZGlzc29u">https://github.com/redisson/redisson</span></p><p><strong>基本使用：</strong></p><ol><li><p>引入依赖： <code>org.redisson.redisson:3.13.6</code> 。</p></li><li><p>客户端配置：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Configuration</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisConfig</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token annotation punctuation">@Bean</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">RedissonClient</span> <span class="token function">redissonClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token class-name">Config</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        config<span class="token punctuation">.</span><span class="token function">useSingleServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span><span class="token string">"redis://127.0.0.1:6379"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">"123456"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token keyword">return</span> <span class="token class-name">Redisson</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>  </pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure></li><li><p>测试使用：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Resource</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">private</span> <span class="token class-name">RedissonClient</span> redissonClient<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token annotation punctuation">@Test</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token class-name">RLock</span> lock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">"lock:order:123764"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">boolean</span> isLock <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>isLock<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"---> TODO 执行业务逻辑"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure></li></ol><p><strong>Redisson 分布式锁原理</strong></p><p><img data-src="https://img.xfc-exclave.com/2022/03/3a5c08426d7714bd67041598cc8457561647263198.png" alt="redisson-lock"></p><p>Redisson 如何处理分布式锁问题：</p><ol><li><p>可重入问题：利用 Hash 结构记录线程 ID 和重入次数。</p></li><li><p>可重试问题：利用信号量和 PubSub 功能实现等待、唤醒、获取锁失败的重试机制。</p></li><li><p>超时续约：利用 watchDog，每隔一段时间（releaseTime / 3）重置锁的超时时间。</p></li><li><p>主从一致性问题：</p><p>Redisson 使用联锁（multiLock）机制，同时存在多个 Redis 主节点，并且获取锁时，需要保证所有主节点内该锁都已被释放。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Resource</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">private</span> <span class="token class-name">RedissonClient</span> redissonClient1<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token annotation punctuation">@Resource</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">private</span> <span class="token class-name">RedissonClient</span> redissonClient2<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token annotation punctuation">@Resource</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">private</span> <span class="token class-name">RedissonClient</span> redissonClient3<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">private</span> <span class="token class-name">RLock</span> lock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token annotation punctuation">@BeforeEach</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">void</span> <span class="token function">setUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token class-name">RLock</span> lock1 <span class="token operator">=</span> redissonClient1<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">"order"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token class-name">RLock</span> lock2 <span class="token operator">=</span> redissonClient2<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">"order"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token class-name">RLock</span> lock3 <span class="token operator">=</span> redissonClient3<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">"order"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    lock <span class="token operator">=</span> redissonClient1<span class="token punctuation">.</span><span class="token function">getMultiLock</span><span class="token punctuation">(</span>lock1<span class="token punctuation">,</span> lock2<span class="token punctuation">,</span> lock3<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>其本质上是对 MultiLock 内所有的锁进行遍历。</p></li></ol><h3 id="redis-消息队列"><a class="anchor" href="#redis-消息队列">#</a> Redis 消息队列</h3><p>通常，对于并发和性能要求都较高的系统或业务，往往需要将流程分片化。例如典型的秒杀项目，出于性能考虑，我们通常会将较为复杂的、耗时较长但无需即时返回结果的请求存储到消息队列中，开启异步线程进行处理，这样既不会到影响业务，同时也提高了系统的性能。</p><p>目前比较流行的消息队列产品包括：RabbitMQ、ActiveMQ、RocketMQ、kafka 等。</p><p>此外，Redis 也提供了三种不同的方式来实现消息队列：</p><ol><li>List 结构：基于 List 结构模拟消息队列。</li><li>PubSub：基本的点对点消息模型。</li><li>Stream：比较完善的消息队列模型（推荐）。</li></ol><h4 id="基于-list-模拟消息队列"><a class="anchor" href="#基于-list-模拟消息队列">#</a> 基于 List 模拟消息队列</h4><p>消息队列，简单理解即时存放消息的队列，而 Redis 的 List 数据结构是一个双向链表，因此我们可以很容易地通过 LPUSH 结合 RPOP 或 RPUSH 结合 LPOP 来模拟出队列的效果。</p><p>但值得注意的是，当 Redis List 中没有消息时，RPOP 或 LPOP 会返回 nil，而不是像 JVM 的阻塞队列那样阻塞并等待消息，因此，在取出消息时应当使用 BRPOP 或 BLPOP 来实现阻塞效果。</p><p>相比 JVM 阻塞队列来说，Redis 实现的阻塞队列具有如下优点：</p><ol><li>不受 JVM 内存大小限制。</li><li>基于 Redis 持久化，可以保证数据安全。</li><li>可以满足消息的有序性。</li></ol><p>缺点：</p><ol><li>无法避免消息丢失（当取出消息但未及时处理时，服务出现异常，会导致消息丢失）。</li><li>只支持单消费者，无法实现多消费者同时消费。</li></ol><h4 id="基于-pubsub-的消息队列"><a class="anchor" href="#基于-pubsub-的消息队列">#</a> 基于 PubSub 的消息队列</h4><p>PubSub 是 Redis 2.0 版本引入的消息传递模型，消费者可以订阅一个或多个 channel，生产者想对应的 channel 发送消息后，所有订阅者都能收到相关消息。</p><ul><li>SUBSCRIBE channel [channel] 订阅一个或多个频道。</li><li>PUBLISH channel msg 向一个频道发送消息。</li><li>PSUBSCRIBE pattern [pattern] 订阅与 pattern 格式匹配的所有频道。</li></ul><p>PubSub 有点：</p><ol><li>采用发布订阅模型，支持多生产、多消费。</li></ol><p>缺点：</p><ol><li>不支持数据持久化。</li><li>无法避免消息丢失。</li><li>消息堆积有上限，超出时消息会丢失。</li></ol><h4 id="基于-stream-的消息队列"><a class="anchor" href="#基于-stream-的消息队列">#</a> 基于 Stream 的消息队列</h4><p>Stream 是 Redis 5.0 引入的一种新的数据类型，可以实现一个功能非常完善的消息队列。</p><p>Stream 消息队列相关命令：</p><ol><li><p>XADD key *|ID field value [field value ...] 发送消息。</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 添加消息</span></pre></td></tr><tr><td data-num="2"></td><td><pre>XADD user:1001 * name chinmoku</pre></td></tr></table></figure></li><li><p>XREAD STREAMS key [key ...] ID [ID ...]</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 从 0 开始读取消息</span></pre></td></tr><tr><td data-num="2"></td><td><pre>XREAD COUNT <span class="token number">1</span> STREAMS user:1001 <span class="token number">0</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># 读取最新消息</span></pre></td></tr><tr><td data-num="4"></td><td><pre>XREAD COUNT <span class="token number">1</span> STREAMS user:1001 $</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 阻塞读取消息</span></pre></td></tr><tr><td data-num="6"></td><td><pre>XREAD COUNT <span class="token number">1</span> BLOCK <span class="token number">1000</span> STREAMS user:1001 $</pre></td></tr></table></figure></li></ol><p>实现消息队列示例：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token comment">// 尝试读取队列中的消息，最多阻塞 2s</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token class-name">Object</span> msg <span class="token operator">=</span> redis<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">"XREAD COUNT 1 BLOCK 2000 STREAMS user:1001 $"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token keyword">continue</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">// 处理消息</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token function">handleMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>STREAM 类型消息队列的 XREAD 命令特点：</p><ul><li>消息可回溯。</li><li>一个消息可以被多个消费者读取。</li><li>可以阻塞读取。</li><li>有消息漏读的风险。</li></ul><p><strong>消费者组（Consumer Group）</strong></p><p>由于单消费者具有消息漏读的风险，因此引入了消费者组概念，所谓消费者组，就是将多个消费者划分到一个组中，监听同一个队列，它具备如下特点：</p><ol><li><p>消息分流：</p><p>队列中的消息会分流给组内的不同消费者，而不是重复消费，从而加快消息处理的速度。</p></li><li><p>消息标示：</p><p>消费者组会维护一个标示，记录最后一个被处理的消息，哪怕消费者宕机重启，仍旧会从标示之后读取消息，保证每一条消息都会被消费。</p></li><li><p>消息确认：</p><p>消费者获取消息后，消息处于 pending 状态，并存入一个 pending-list 中，当处理完成后需要通过 XACK 来确认消息，标记消息为已处理，这时才会从 pending-list 中移除。</p></li></ol><p>Stream Consumer Group 相关操作命令：</p><ol><li>XGROUP CREATE key groupName ID [MKSTREAM] 创建消费者组。</li><li>XGROUP DESTORY key groupName 删除消费者组。</li><li>XGROUP CREATECONSUMER key groupName consumername 给指定消费者组添加消费者。</li><li>XGROUP DELCONSUMER key groupName consumername 删除消费者组中指定消费者。</li><li>XREADGROUP GROUP group consumer STREAMS key [key ...] ID [ID ...] 从消费者组读取消息。</li><li>XACK key group ID [ID ...] 确认消息（读取消息后需要进行确认）。</li><li>XPENDING key group [start end count] 获取未确认的消息。</li></ol><p>伪代码实现消费者组监听逻辑：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">white</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token comment">// 尝试监听队列，使用阻塞模式，最长等待 2000ms</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token class-name">Object</span> msg <span class="token operator">=</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">"XREADGROUP GROUP g1 c1 COUNT 1 BLOCK 200 STREAMS S1 >"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 没有消息，则继续下一次</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token keyword">continue</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token comment">// 处理消息，完成后并做 ACK</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token function">handleMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token comment">// 从 pending-list 中读取消息</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            <span class="token class-name">Object</span> msg <span class="token operator">=</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">"XREADGROUP GROUP g1 s1 COUNT 1 STREAMS s1 0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>                <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>                <span class="token comment">// 存在异常消息，再次处理</span></pre></td></tr><tr><td data-num="19"></td><td><pre>                <span class="token function">handleMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>                <span class="token comment">// 再次出现异常，继续循环</span></pre></td></tr><tr><td data-num="22"></td><td><pre>                <span class="token keyword">continue</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>STREAM 类型消息队列的 XREADGROUP 命令特点：</p><ul><li>消息可回溯。</li><li>可以多消费者争抢消息，加快消费速度。</li><li>可以阻塞读取。</li><li>没有消息漏读风险。</li><li>有消息确认机制，保证消息至少被消费一次。</li></ul><p><strong>Redis 消息队列对比：</strong></p><table><thead><tr><th></th><th>List</th><th>PubSub</th><th>Stream</th></tr></thead><tbody><tr><td>消息持久化</td><td>支持</td><td>不支持</td><td>支持</td></tr><tr><td>阻塞读取</td><td>支持</td><td>支持</td><td>支持</td></tr><tr><td>消息堆积处理</td><td>受内存空间限制，可以利用多消费者加快处理</td><td>受限于消费者缓冲区</td><td>受限于队列长度，可以利用消费者组提高消费速度，减少堆积</td></tr><tr><td>消息确认机制</td><td>不支持</td><td>不支持</td><td>支持</td></tr><tr><td>消息回溯</td><td>不支持</td><td>不支持</td><td>支持</td></tr></tbody></table><blockquote><p>使用 Redis 作为消息队列，推荐使用 Stream，但 Redis 毕竟并非主要用于消息队列，因此在对消息队列性能要求较高的项目中，还是推荐使用专门的消息队列产品。</p></blockquote><h3 id="参考"><a class="anchor" href="#参考">#</a> 参考</h3><blockquote><p>参考内容来源于网络，本文不保证参考链接的长期有效性，以及参考内容的原创性。</p></blockquote><ul><li><p><span class="exturl" data-url="aHR0cHM6Ly9yZWRpcy5pby9jb21tYW5kcw==">https://redis.io/commands</span></p></li><li><p><span class="exturl" data-url="aHR0cHM6Ly93d3cuYmlsaWJpbGkuY29tL3ZpZGVvL0JWMWNyNHkxNjcxdA==">https://www.bilibili.com/video/BV1cr4y1671t</span></p><p><span class="label primary">♥️ 推荐</span> 这个教程大致涉及了 Redis 基础及原理、分布式锁和 Redis 消息队列这几大内容，重点倾向于 Redis 基础及并发解决方案，目前似乎仍在持续更新，管道、集群等知识大概是要等后续更新吧。总体感觉相当良好，特别是 PPT 做得真的是眼前一亮。（就事论事）</p></li><li><p><span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vaXRwbGF5L3AvMTEwOTg5OTAuaHRtbA==">https://www.cnblogs.com/itplay/p/11098990.html</span></p></li></ul><div class="tags"><a href="/tags/java/" rel="tag"><i class="ic i-tag"></i> java</a> <a href="/tags/Spring-Cloud-Alibaba/" rel="tag"><i class="ic i-tag"></i> Spring Cloud Alibaba</a></div></div><footer><div class="meta"><span id="computer-science/java-learning-path/3-advanced/redis-tutorial/" class="item leancloud_visitors" data-flag-title="Redis 如何保证高性能" title="閲覧数"><span class="icon"><i class="ic i-eye"></i> </span><span class="text">閲覧数</span> <span class="leancloud-visitors-count"></span> <span class="text">回</span></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> 寄付</button><p>*~(￣▽￣)~[お茶]を一杯ください</p><div id="qr"><div><img data-src="/images/wechatpay.png" alt="チンモク WeChat 支払う"><p>WeChat 支払う</p></div><div><img data-src="/images/alipay.png" alt="チンモク Alipay"><p>Alipay</p></div><div><img data-src="/images/paypal.png" alt="チンモク PayPal"><p>PayPal</p></div></div></div><div id="copyright"><ul><li class="author"><strong>著者： </strong>チンモク <i class="ic i-at"><em>@</em></i>チンモクのブログ</li><li class="link"><strong>記事へのリンク：</strong> <a href="https://www.chinmoku.cc/computer-science/java-learning-path/3-advanced/redis-tutorial/" title="Redis 如何保证高性能">https://www.chinmoku.cc/computer-science/java-learning-path/3-advanced/redis-tutorial/</a></li><li class="license"><strong>著作権表示： </strong>このブログ内のすべての記事は、特別な記載がない限り <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> の下のライセンスで保護されています。</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/blog-log/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;reference-1301046789.cos.ap-nanjing.myqcloud.com&#x2F;blog-img&#x2F;35500212880a11ebb6edd017c2d2eca2.png" title="【长期置顶】博客文章更新日志"><span class="type">前の記事</span> <span class="category"><i class="ic i-flag"></i></span><h3>【长期置顶】博客文章更新日志</h3></a></div><div class="item right"><a href="/computer-science/web/react-tutorial/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;reference-1301046789.cos.ap-nanjing.myqcloud.com&#x2F;blog-img&#x2F;82c137a7170d4b2cad69db1263f73469.jpg" title="React 通关指南"><span class="type">次の記事</span> <span class="category"><i class="ic i-flag"></i> React 教程</span><h3>React 通关指南</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="見出し"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#redis-%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">Redis 简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%B8%E8%BD%BD%E5%AE%89%E8%A3%85"><span class="toc-number">2.</span> <span class="toc-text">卸载安装</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#redis-%E5%8D%B8%E8%BD%BD"><span class="toc-number">2.1.</span> <span class="toc-text">Redis 卸载</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#redis-%E5%AE%89%E8%A3%85"><span class="toc-number">2.2.</span> <span class="toc-text">Redis 安装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#redis-%E8%BF%9E%E6%8E%A5"><span class="toc-number">2.3.</span> <span class="toc-text">Redis 连接</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#redis-%E5%91%BD%E4%BB%A4"><span class="toc-number">3.</span> <span class="toc-text">Redis 命令</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-number">3.1.</span> <span class="toc-text">数据结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="toc-number">3.2.</span> <span class="toc-text">通用命令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#string-%E7%B1%BB%E5%9E%8B"><span class="toc-number">3.3.</span> <span class="toc-text">String 类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#hash-%E7%B1%BB%E5%9E%8B"><span class="toc-number">3.4.</span> <span class="toc-text">Hash 类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#list-%E7%B1%BB%E5%9E%8B"><span class="toc-number">3.5.</span> <span class="toc-text">List 类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#set-%E7%B1%BB%E5%9E%8B"><span class="toc-number">3.6.</span> <span class="toc-text">Set 类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#sortedset-%E7%B1%BB%E5%9E%8B"><span class="toc-number">3.7.</span> <span class="toc-text">SortedSet 类型</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#java-%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">4.</span> <span class="toc-text">Java 客户端</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#jedis"><span class="toc-number">4.1.</span> <span class="toc-text">Jedis</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#springdataredis"><span class="toc-number">4.2.</span> <span class="toc-text">SpringDataRedis</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E9%97%AE%E9%A2%98%E5%8F%8A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">5.</span> <span class="toc-text">缓存问题及解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E6%9B%B4%E6%96%B0%E7%AD%96%E7%95%A5"><span class="toc-number">5.1.</span> <span class="toc-text">缓存更新策略</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F"><span class="toc-number">5.2.</span> <span class="toc-text">缓存穿透</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E9%9B%AA%E5%B4%A9"><span class="toc-number">5.3.</span> <span class="toc-text">缓存雪崩</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF"><span class="toc-number">5.4.</span> <span class="toc-text">缓存击穿</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">5.5.</span> <span class="toc-text">代码实现</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#redis-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81"><span class="toc-number">6.</span> <span class="toc-text">Redis 分布式锁</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E-redis-%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81"><span class="toc-number">6.1.</span> <span class="toc-text">基于 Redis 实现分布式锁</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#redisson"><span class="toc-number">6.2.</span> <span class="toc-text">Redisson</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#redis-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="toc-number">7.</span> <span class="toc-text">Redis 消息队列</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E-list-%E6%A8%A1%E6%8B%9F%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="toc-number">7.1.</span> <span class="toc-text">基于 List 模拟消息队列</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E-pubsub-%E7%9A%84%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="toc-number">7.2.</span> <span class="toc-text">基于 PubSub 的消息队列</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E-stream-%E7%9A%84%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="toc-number">7.3.</span> <span class="toc-text">基于 Stream 的消息队列</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">8.</span> <span class="toc-text">参考</span></a></li></ol></div><div class="related panel pjax" data-title="関連記事"><ul><li><a href="/computer-science/java-learning-path/2-intermediate/spring-tutorial/" rel="bookmark" title="Spring 教程">Spring 教程</a></li><li><a href="/computer-science/java-learning-path/2-intermediate/mybatis-tutorial/" rel="bookmark" title="MyBatis 教程">MyBatis 教程</a></li><li><a href="/computer-science/java-learning-path/2-intermediate/springcloud-tutorial/" rel="bookmark" title="SpringCloud 教程（Finchley.RELEASE）">SpringCloud 教程（Finchley.RELEASE）</a></li><li><a href="/computer-science/java-learning-path/2-intermediate/webservice-tutorial/" rel="bookmark" title="WebService，如此而已">WebService，如此而已</a></li><li><a href="/computer-science/java-learning-path/2-intermediate/dubbo-tutorial/" rel="bookmark" title="Dubbo 知识整理">Dubbo 知识整理</a></li><li class="active"><a href="/computer-science/java-learning-path/3-advanced/redis-tutorial/" rel="bookmark" title="Redis 如何保证高性能">Redis 如何保证高性能</a></li></ul></div><div class="overview panel" data-title="概要"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="チンモク" data-src="/images/avatar.jpg"><p class="name" itemprop="name">チンモク</p><div class="description" itemprop="description">本站主要以 Java 开发总结文章为主，也会向技术周边进行适当的扩展。此外，偶尔会更新部分其他学习或感兴趣的内容，如语言学习、文本翻译、文艺创作等。</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">23</span> <span class="name">ポスト</span></a></div><div class="item categories"><a href="/categories/"><span class="count">15</span> <span class="name">カテゴリ</span></a></div><div class="item tags"><a href="/tags/"><span class="count">20</span> <span class="name">タグ</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL3hmYy1leGNsYXZl" title="https:&#x2F;&#x2F;github.com&#x2F;xfc-exclave"><i class="ic i-github"></i></span> <span class="exturl item twitter" data-url="aHR0cHM6Ly90d2l0dGVyLmNvbS95b3VybmFtZQ==" title="https:&#x2F;&#x2F;twitter.com&#x2F;yourname"><i class="ic i-twitter"></i></span> <span class="exturl item zhihu" data-url="aHR0cHM6Ly93d3cuemhpaHUuY29tL3Blb3BsZS95b3VybmFtZQ==" title="https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;yourname"><i class="ic i-zhihu"></i></span> <span class="exturl item music" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLyMvdXNlci9ob21lP2lkPTExMjg2ODg2Mw==" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;112868863"><i class="ic i-cloud-music"></i></span> <span class="exturl item weibo" data-url="aHR0cHM6Ly93ZWliby5jb20vYW1laGltZQ==" title="https:&#x2F;&#x2F;weibo.com&#x2F;amehime"><i class="ic i-weibo"></i></span> <span class="exturl item about" data-url="aHR0cHM6Ly9hYm91dC5tZS95b3VybmFtZQ==" title="https:&#x2F;&#x2F;about.me&#x2F;yourname"><i class="ic i-address-card"></i></span> <span class="exturl item email" data-url="bWFpbHRvOnhmY19leGNsYXZlQDE2My5jb20=" title="mailto:xfc_exclave@163.com"><i class="ic i-envelope"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>ホーム</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>投稿</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>アーカイブ</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>カテゴリ</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>タグ</a></li></ul></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-link-circle"></i>リンク</a><ul class="submenu"><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>友人帳</a></li><li class="item"><a href="/websites/" rel="section"><i class="ic i-sun"></i>サイト</a></li></ul></li><li class="item"><a href="/plan/" rel="section"><i class="ic i-stars"></i>学習計画</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/blog-log/" rel="prev" title="前の記事"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/computer-science/web/react-tutorial/" rel="next" title="次の記事"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>ランダムな記事</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="カテゴリ 计算机科学">计算机科学</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java-learning-path/" title="カテゴリ JAVA 学习路线">JAVA 学习路线</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java-learning-path/%E8%BF%9B%E9%98%B6%E7%AF%87/" title="カテゴリ 进阶篇">进阶篇</a></div><span><a href="/computer-science/java-learning-path/2-intermediate/springcloud-tutorial/" title="SpringCloud 教程（Finchley.RELEASE）">SpringCloud 教程（Finchley.RELEASE）</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="カテゴリ 计算机科学">计算机科学</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java-learning-path/" title="カテゴリ JAVA 学习路线">JAVA 学习路线</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java-learning-path/%E5%9F%BA%E7%A1%80%E7%AF%87/" title="カテゴリ 基础篇">基础篇</a></div><span><a href="/computer-science/java-learning-path/1-basic/02-java-concurrency/" title="Java 并发编程知识整理">Java 并发编程知识整理</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="カテゴリ 计算机科学">计算机科学</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/Python%E5%85%A5%E9%97%A8%E6%95%99%E7%A8%8B/" title="カテゴリ Python 入门教程">Python 入门教程</a></div><span><a href="/computer-science/python/python-all-base/" title="Python 基础知识全通关">Python 基础知识全通关</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="カテゴリ 计算机科学">计算机科学</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java-learning-path/" title="カテゴリ JAVA 学习路线">JAVA 学习路线</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java-learning-path/%E8%BF%9B%E9%98%B6%E7%AF%87/" title="カテゴリ 进阶篇">进阶篇</a></div><span><a href="/computer-science/java-learning-path/2-intermediate/spring-tutorial/" title="Spring 教程">Spring 教程</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="カテゴリ 计算机科学">计算机科学</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java-learning-path/" title="カテゴリ JAVA 学习路线">JAVA 学习路线</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java-learning-path/%E6%89%A9%E5%B1%95%E7%AF%87/" title="カテゴリ 扩展篇">扩展篇</a></div><span><a href="/computer-science/java-learning-path/3-advanced/elasticsearch-tutorial/" title="Elasticsearch 教程">Elasticsearch 教程</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="カテゴリ 计算机科学">计算机科学</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/WEB%E5%89%8D%E7%AB%AF/" title="カテゴリ WEB 前端">WEB 前端</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/WEB%E5%89%8D%E7%AB%AF/React-%E6%95%99%E7%A8%8B/" title="カテゴリ React 教程">React 教程</a></div><span><a href="/computer-science/web/react-tutorial/" title="React 通关指南">React 通关指南</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="カテゴリ 计算机科学">计算机科学</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java-learning-path/" title="カテゴリ JAVA 学习路线">JAVA 学习路线</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java-learning-path/%E8%BF%9B%E9%98%B6%E7%AF%87/" title="カテゴリ 进阶篇">进阶篇</a></div><span><a href="/computer-science/java-learning-path/2-intermediate/mybatis-tutorial/" title="MyBatis 教程">MyBatis 教程</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/blog-log/" title="【长期置顶】博客文章更新日志">【长期置顶】博客文章更新日志</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="カテゴリ 计算机科学">计算机科学</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/Python%E5%85%A5%E9%97%A8%E6%95%99%E7%A8%8B/" title="カテゴリ Python 入门教程">Python 入门教程</a></div><span><a href="/computer-science/python/django-tutorial/" title="Django 网站全栈开发教程">Django 网站全栈开发教程</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="カテゴリ 计算机科学">计算机科学</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/JAVA-%E5%AD%A6%E4%B9%A0%E8%B7%AF%E7%BA%BF/" title="カテゴリ JAVA 学习路线">JAVA 学习路线</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java-learning-path/%E6%89%A9%E5%B1%95%E7%AF%87/" title="カテゴリ 扩展篇">扩展篇</a></div><span><a href="/computer-science/java-learning-path/6-extension/quartz-tutorial/" title="Quartz 快速入门及常规使用">Quartz 快速入门及常规使用</a></span></li></ul></div><div><h2>最近のコメント</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2020 – <span itemprop="copyrightYear">2022</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">チンモク @ Chinmoku</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="単語の総数">593k 単語</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="読書の合計時間">8:59</span></div><div class="powered-by">Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"computer-science/java-learning-path/3-advanced/redis-tutorial/",favicon:{show:"（●´3｀●）やれやれだぜ",hide:"(´Д｀)大変だ！"},search:{placeholder:"検索…",empty:"「 ${query} 」については何も見つかりませんでした",stats:"${time} ms以内に ${hits} 件の結果が見つかりました"},valine:!0,fancybox:!0,copyright:"コピーは成功しました。 <br> 再印刷については、 ％s 契約に従ってください。",ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html>